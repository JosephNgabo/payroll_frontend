<div class="container-fluid">
  <!-- start page title -->
  <!-- end page title -->

  <!-- Back Button -->
  <div class="mb-3">
    <button class="btn btn-outline-secondary" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Back to Workflows
    </button>
  </div>

  <!-- Debug Information -->
  <div class="alert alert-info" *ngIf="loading">
    <strong>Loading:</strong> {{ loading }} | <strong>Workflow ID:</strong> {{ workflowId }} | <strong>Workflow
      Object:</strong> {{ workflowObj ? 'Loaded' : 'Not Loaded' }}
  </div>


  <div class="alert alert-warning" *ngIf="!loading && !workflowObj">
    <strong>No Data Available</strong> | <strong>Workflow ID:</strong> {{ workflowId }} | <strong>Loading
      State:</strong> {{ loading }}
  </div>

  <!-- Workflow Information -->
  <div class="card mt-3" *ngIf="!loading">
    <div class="card-body workflow-info-compact">
      <div class="row">
        <div class="col">
          <label>Workflow Name</label>
        </div>
        <div class="col">
          <span>{{ workflowObj?.name | titlecase }}</span>
        </div>
        <div class="col">
          <label>Status</label>
        </div>
        <div class="col">
          <div class="span-status">
            <span class="statusClass" [ngClass]="{
                statusClassActive: workflowObj?.active == true,
                statusClassInActive: workflowObj?.active == false
              }">
              {{ workflowObj?.active ? "Active" : "Inactive" }}</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Code</label>
        </div>
        <div class="col">
          <span>{{ workflowObj?.code | titlecase }}</span>
        </div>
        <div class="col">
          <label>Entity Type</label>
        </div>
        <div class="col">
          <span>{{ workflowObj?.entity_type | titlecase }}</span>
        </div>
      </div>

      <div class="row">
        <div class="col-3">
          <label>Description</label>
        </div>
        <div class="col">
          <p>
            {{ workflowObj?.description | titlecase }}
          </p>
        </div>
      </div>

      <!-- Notifications Section -->
      <div class="row">
        <div class="col-3">
          <label>Notifications</label>
        </div>
        <div class="col">
          <div class="d-flex gap-2">
            <span class="badge badge-soft-info" *ngIf="workflowObj?.settings?.notifications?.email">Email</span>
            <span class="badge badge-soft-info" *ngIf="workflowObj?.settings?.notifications?.sms">SMS</span>
            <span class="badge badge-soft-info" *ngIf="workflowObj?.settings?.notifications?.in_app">In-App</span>
          </div>
        </div>
      </div>


    </div>
  </div>

  <!-- Workflow Actions Table -->
  <div class="card mt-3" *ngIf="!loading">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0">Workflow Actions</h5>
        <button class="btn btn-primary btn-sm" (click)="openAddActionModal()">
          <i class="fas fa-plus"></i> Add New Action
        </button>
      </div>
      <div class="table-responsive">
        <table class="table mb-0">
          <thead class="table-light">
            <tr>
              <th class="poppins-medium" scope="col">
                #
              </th>
              <th class="poppins-medium" scope="col">
                Step ID
              </th>
              <th class="poppins-medium" scope="col">
                Action
              </th>
              <th class="poppins-medium" scope="col">
                Actor
              </th>
              <th class="poppins-medium" scope="col">
                Actor Value
              </th>
              <th class="poppins-medium" scope="col">
                Parent
              </th>
              <th class="poppins-medium" scope="col">
                Actions
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of workflowConfigObj; let i = index">
              <td class="DataRowClass">{{ i + 1 }}</td>
              <td class="DataRowClass">{{ item.action_identifier | titlecase }}</td>
              <td class="DataRowClass">{{ item.action_type | titlecase }}</td>
              <td class="DataRowClass">{{ getActorTypeLabel(item.type_actor) }}</td>
              <td class="DataRowClass">{{ getActorName(item) }}</td>
              <td class="DataRowClass">{{ item.parent === '0' ? 'None' : getParentActionIdentifier(item.parent) | titlecase }}</td>
              <td class="DataRowClass">
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-primary" (click)="updateWorkflowAction(item)" title="Update">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" (click)="deleteWorkflowAction(item.id)" title="Delete">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="data-section" *ngIf="updating">
    <ul ngbNav #customNav="ngbNav" [activeId]="1">
      <li [ngbNavItem]="1" [ngClass]="[ active === 1 ? 'qt-bg-' + theme + '-800' : 'qt-bg-' + theme + '-100' ]">
        <a ngbNavLink (click)="changeActiveClass(1)"
          [ngClass]="[ active === 1 ? 'qt-text-' + theme + '-50' : 'qt-text-' + theme + '-800' ]">
          <span class="d-block d-sm-none"><i class="fas fa-home"></i></span>
          <span class="d-none d-sm-block poppins-medium qt-fs-5">{{
            "PAGES.WORKFLOW.DETAILS.updating.tabs.tab1" | translate
            }}</span>
        </a>
        <ng-template ngbNavContent>
          <div class="card mt-3">
            <div class="card-body tr08091302">
              <div class="card-body">
                <div class="row">
                  <div class="col">
                    <label for="">{{
                      "PAGES.WORKFLOW.DETAILS.updating.general.l1" | translate
                      }}</label>
                    <div class="mt-1 mb-3">
                      <input type="text" disabled class="form-control" [(ngModel)]="v_workflow"
                        id="exampleFormControlInput1" placeholder="Workflow Name" />
                    </div>
                    <label for="">{{
                      "PAGES.WORKFLOW.DETAILS.updating.general.l2" | translate
                      }}</label>
                    <div class="mt-1 mb-3">
                      <textarea disabled class="form-control" [(ngModel)]="v_desc" id="exampleFormControlTextarea1"
                        rows="3"></textarea>
                    </div>
                  </div>
                  <div class="col">
                    <label for="">{{
                      "PAGES.WORKFLOW.DETAILS.updating.general.l3" | translate
                      }}</label>
                    <div class="mb-3">
                      <ng-select [disabled]="true" [searchable]="true" appendTo="body" bindLabel="name"
                        [(ngModel)]="id_scenario" placeholder="Select senario"
                        (change)="getWorkflowLevelsBySenario($event)">
                        <ng-option *ngFor="let option of senariosObj" [value]="option.id_scenario">
                          {{ option.scenario | titlecase }}
                        </ng-option>
                      </ng-select>
                    </div>

                    <div class="level" *ngIf="steps >= 1">
                      <label for="">
                        {{"PAGES.WORKFLOW.DETAILS.updating.general.l4" | translate }}

                      </label>
                      <div class="mt-1 mb-3">
                        <ng-select [disabled]="true" bindLabel="name" [searchable]="true" appendTo="body"
                          [(ngModel)]="selected_levelI" placeholder="Select level"
                          (change)="getWorkflowSublevels($event, 2)">
                          <ng-option *ngFor="let option of workflowLevelsObj" [value]="option.id_level">
                            {{ option.level | titlecase }}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>

                    <div class="level" *ngIf="steps >= 2">
                      <label for="">{{
                        "PAGES.WORKFLOW.DETAILS.updating.general.l5" | translate
                        }}</label>
                      <div class="mt-1 mb-3">
                        <ng-select [disabled]="true" bindLabel="name" [searchable]="true" appendTo="body"
                          [(ngModel)]="selected_levelII" placeholder="Select sub level"
                          (change)="getWorkflowSublevels($event, 3)">
                          <ng-option *ngFor="let option of subLevelsObj_1" [value]="option.id_level">
                            {{ option.level | titlecase }}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>
                    <div class="level" *ngIf="steps >= 3">
                      <label for="">{{
                        "PAGES.WORKFLOW.DETAILS.updating.general.l6" | translate
                        }}</label>
                      <div class="mb-2">
                        <ng-select [disabled]="true" bindLabel="name" [searchable]="true" appendTo="body"
                          [(ngModel)]="selected_levelIII" placeholder="Select sub level"
                          (change)="getWorkflowSublevels($event, 4)">
                          <ng-option *ngFor="let option of subLevelsObj_2" [value]="option.id_level">
                            {{ option.level | titlecase }}
                          </ng-option>
                        </ng-select>
                      </div>
                    </div>

                    <div *ngIf="loading_l" class="d-flex justify-content-center">
                      <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>
      <li [ngbNavItem]="2" [ngClass]="[ active === 2 ? 'qt-bg-' + theme + '-800' : 'qt-bg-' + theme + '-100' ]">
        <a ngbNavLink (click)="changeActiveClass(2)"
          [ngClass]="[ active === 2 ? 'qt-text-' + theme + '-50' : 'qt-text-' + theme + '-800' ]">
          <span class="d-block d-sm-none"><i class="fas fa-align-justify"></i></span>
          <span class="d-none d-sm-block poppins-medium qt-fs-5">{{
            "PAGES.WORKFLOW.DETAILS.updating.tabs.tab2" | translate
            }}</span>
        </a>
        <ng-template ngbNavContent>
          <div class="card mt-3">
            <div class="card-body tr08091300">
              <div class="row" *ngIf="editProcess" [formGroup]="editFormGroup">
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l1" | translate
                    }}</label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_action"
                      placeholder="Select action">
                      <ng-option *ngFor="let option of workflowActionObj" [value]="option?.id_action">
                        {{ option?.action | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l2" | translate
                    }}</label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_type_actor"
                      placeholder="Select actor type" (change)="onActorChange($event)">
                      <ng-option *ngFor="let option of actors" [value]="option.id">
                        {{ option.label | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l3" | translate
                    }}</label>

                  <div class="" *ngIf="selectUsers">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_actor"
                      placeholder="Select User">
                      <ng-option *ngFor="let option of usersObj" [value]="option.id_utilis">
                        {{ option.nom | titlecase }}
                        {{ option.prenom | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>

                  <div class="" *ngIf="!selectUsers">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_actor"
                      placeholder="Select group">
                      <ng-option *ngFor="let option of groupsObj" [value]="option.id_grp">
                        {{ option.group_name | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">
                    <!-- {{"PAGES.WORKFLOW.DETAILS.updating.actions.l4" | translate}} -->
                    This is not
                  </label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_parent"
                      placeholder="Select parent">
                      <ng-option [value]="0"> None </ng-option>
                      <ng-option *ngFor="let option of workflowParentsObj" [value]="option.parent">
                        {{ option.action | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>

                <div class="col d-flex align-items-end justfy-content-start">
                  <button (click)="updateWorkflowConfig()" class="btn btn-primary bg-transparent text-primary">
                    {{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.update"
                    | translate
                    }}
                  </button>

                  <button (click)="cancelEditAction()" class="btn btn-danger bg-transparent ms-2 text-danger">
                    {{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.cancel"
                    | translate
                    }}
                  </button>
                </div>
              </div>

              <div class="row" *ngIf="!editProcess" [formGroup]="formGroup">
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l1" | translate
                    }}</label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_action"
                      placeholder="Select action">
                      <ng-option *ngFor="let option of workflowActionObj" [value]="option?.id_action">
                        {{ option?.action | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l2" | translate
                    }}</label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_type_actor"
                      placeholder="Select actor type" (change)="onActorChange($event)">
                      <ng-option *ngFor="let option of actors" [value]="option.id">
                        {{ option.label | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l3" | translate
                    }}</label>
                  <div class="" *ngIf="selectUsers">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_actor"
                      placeholder="Select User">
                      <ng-option *ngFor="let option of usersObj" [value]="option.id_utilis">
                        {{ option.nom | titlecase }}
                        {{ option.prenom | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                  <div class="" *ngIf="!selectUsers">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_id_actor"
                      placeholder="Select group">
                      <ng-option *ngFor="let option of groupsObj" [value]="option.id_grp">
                        {{ option.group_name }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col">
                  <label for="basicpill-email-input">{{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.l4" | translate
                    }}</label>
                  <div class="">
                    <ng-select bindLabel="name" [searchable]="true" appendTo="body" formControlName="v_parent"
                      placeholder="Select parent">
                      <ng-option [value]="0"> None </ng-option>
                      <ng-option *ngFor="let option of workflowParentsObj" [value]="option.parent">
                        {{ option.action | titlecase }}
                      </ng-option>
                    </ng-select>
                  </div>
                </div>
                <div class="col d-flex align-items-end">
                  <button (click)="addWorkflowConfig()" class="btn btn-primary bg-transparent text-primary">
                    {{
                    "PAGES.WORKFLOW.DETAILS.updating.actions.add" | translate
                    }}
                  </button>
                </div>
              </div>

              <div class="table-responsive mt-3" *ngIf="workflowConfigObj?.length > 0">
                <table class="table">
                  <thead class="table-light">
                    <tr>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h1"
                        | translate
                        }}
                      </th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h2"
                        | translate
                        }}
                      </th>
                      <th>Action Identifier</th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h3"
                        | translate
                        }}
                      </th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h4"
                        | translate
                        }}
                      </th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h5"
                        | translate
                        }}
                      </th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h6"
                        | translate
                        }}
                      </th>
                      <th>
                        {{
                        "PAGES.WORKFLOW.DETAILS.updating.actions.table.h7"
                        | translate
                        }}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let item of workflowConfigObj; let i = index">
                      <th>{{ i + 1 }}</th>
                      <td>{{ item.id }}</td>
                      <td>{{ item.action_identifier }}</td>
                      <td>{{ item.action_type | titlecase }}</td>
                      <td>{{ getActorTypeLabel(item.type_actor) }}</td>
                      <td>{{ getActorName(item) }}</td>
                      <td>{{ item.parent === '0' ? 'None' : getParentActionIdentifier(item.parent) }}</td>
                      <td>
                        <button (click)="createEditFormGroup(item)" class="m-1 border-0 bg-transparent text-primary">
                          Edit
                        </button>
                        <button (click)="deleteWorkflowConfig(item.id)" class="m-1 border-0 bg-transparent text-danger">
                          Delete
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="customNav"></div>
  </div>

  <div class="d-flex align-items-center flex-wrap" *ngIf="!loading">
    <!-- Toggle Status Button -->
    <div class="btn btn-sm ps-5 pe-5 me-2 poppins-regular"
      [ngClass]="workflowObj?.active ? 'btn-success' : 'btn-warning'" style="width: 150px"
      (click)="toggleWorkflowStatus()" [disabled]="toggleLoading">
      <span *ngIf="toggleLoading" class="spinner-border spinner-border-sm me-2" role="status">
        <span class="sr-only">Loading...</span>
      </span>
      {{ workflowObj?.active ? 'Deactivate' : 'Activate' }}
    </div>

  </div>
</div>

<!-- Loading indicator -->
<div *ngIf="loading" class="d-flex justify-content-center align-items-center" style="height: 200px;">
  <div class="spinner-border text-primary" role="status">
    <span class="sr-only">Loading...</span>
  </div>
</div>

<!-- Add Action Modal -->
<div class="modal fade" id="addActionModal" tabindex="-1" aria-labelledby="addActionModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
                   <div class="modal-header">
               <h5 class="modal-title" id="addActionModalLabel">
                 {{ isEditMode ? 'Edit Workflow Action' : 'Add New Workflow Action' }}
               </h5>
               <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
             </div>
      <div class="modal-body">
        <form [formGroup]="addActionForm" (ngSubmit)="submitAddAction()">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="actionType" class="form-label">Action Type <span class="text-danger">*</span></label>
                <select class="form-select" [class.is-invalid]="isFieldInvalid('action_type')" id="actionType"
                  formControlName="action_type" (change)="onActionTypeChange()">
                  <option value="">Select Action Type</option>
                  <option value="approve">Approve</option>
                  <option value="reject">Reject</option>
                </select>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('action_type')">
                  {{ getFieldError('action_type') }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="actorType" class="form-label">Actor Type <span class="text-danger">*</span></label>
                <select class="form-select" [class.is-invalid]="isFieldInvalid('type_actor')" id="actorType"
                  formControlName="type_actor" (change)="onActorTypeChange()">
                  <option value="">Select Actor Type</option>
                  <option value="1">User</option>
                  <option value="2">Group</option>
                </select>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('type_actor')">
                  {{ getFieldError('type_actor') }}
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="actorId" class="form-label">Actor <span class="text-danger">*</span></label>
                <select class="form-select" [class.is-invalid]="isFieldInvalid('id_actor')" id="actorId"
                  formControlName="id_actor">
                  <option value="">Select Actor</option>
                  <ng-container *ngIf="addActionForm.get('type_actor')?.value === '1'">
                    <option *ngFor="let user of availableUsers" [value]="user.id">
                      {{ user.firstname }} {{ user.lastname }}
                    </option>
                  </ng-container>
                  <ng-container *ngIf="addActionForm.get('type_actor')?.value === '2'">
                    <option *ngFor="let group of availableGroups" [value]="group.id">
                      {{ group.name }}
                    </option>
                  </ng-container>
                </select>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('id_actor')">
                  {{ getFieldError('id_actor') }}
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="parentAction" class="form-label">Parent Action</label>
                <select class="form-select" [class.is-invalid]="isFieldInvalid('parent')" id="parentAction"
                  formControlName="parent">
                  <option value="0">None</option>
                  <option *ngFor="let action of availableParentActions" [value]="action.id">
                    {{ action.action_identifier }} - {{ getActorName(action) }}
                  </option>
                </select>
                <div class="invalid-feedback" *ngIf="isFieldInvalid('parent')">
                  {{ getFieldError('parent') }}
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="!isFormValid() || addActionLoading"
              [class.btn-secondary]="!isFormValid()">
                             <span *ngIf="addActionLoading" class="spinner-border spinner-border-sm me-2" role="status">
                 <span class="sr-only">Loading...</span>
               </span>
               {{ addActionLoading ? (isEditMode ? 'Updating...' : 'Adding...') : (isEditMode ? 'Update Action' : 'Add Action') }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>