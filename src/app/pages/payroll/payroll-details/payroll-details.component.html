<ng-container class="main-container">

<div class="container-fluid">

    <!-- Card -->
    <div class="card">

        <!-- Header with status -->
        <div class="card-header">
            <h5 class="card-title">
                <i class="bi bi-calendar-event me-2"></i>
                {{ payrollDate | date:'MMM yyyy' }} Payroll
            </h5>
            <span class="status-badge" [ngClass]="getPayrollStatusBadgeClass(details?.payroll_status)">
                {{ getPayrollStatusLabel(details?.payroll_status) }}
            </span>
        </div>

        <!-- Search + Buttons -->
        <div class="action-row">
            <input type="text" 
                   placeholder="Search employee by name or mobile" 
                   class="search-input"
                   [(ngModel)]="searchTerm" 
                   (input)="onSearch()">
            <button class="action-btn">
                <i class="bi bi-person-x me-1"></i>
                Suspended employees · {{ getSuspendedCount() }}
            </button>
            <button class="action-btn">
                <i class="bi bi-columns me-1"></i>
                Customize columns
            </button>
            <button class="action-btn">
                <i class="bi bi-funnel me-1"></i>
                Filter by
            </button>
            <button class="action-btn" (click)="exportPayroll()">
                <i class="bi bi-download me-1"></i>
                Export
            </button>
        </div>

        <!-- Table -->
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th class="employee-details-header">
                            <div class="header-content">
                                <input type="checkbox" class="select-all-checkbox">
                                <span>Employee details</span>
                            </div>
                        </th>
                        <th class="earnings-header" colspan="3">
                            <div class="header-content d-flex justify-content-center">
                                <span>Earnings</span>
                                <div class="header-actions">
                                    <i class="bi bi-chevron-left"></i>
                                    <i class="bi bi-chevron-right"></i>
                                    <i class="bi bi-plus"></i>
                                </div>
                            </div>
                        </th>
                        <th class="deductions-header" colspan="4">
                            <div class="header-content">
                                <span>Deductions</span>
                                <div class="header-actions">
                                    <i class="bi bi-chevron-left"></i>
                                    <i class="bi bi-chevron-right"></i>
                                    <i class="bi bi-plus"></i>
                                </div>
                            </div>
                        </th>
                                                 <th class="total-header" colspan="2">
                             <div class="header-content">
                                 <span>Total</span>
                                 <div class="header-actions">
                                     <i class="bi bi-chevron-left"></i>
                                     <i class="bi bi-chevron-right"></i>
                                     <i class="bi bi-plus"></i>
                                 </div>
                             </div>
                         </th>
                        <th class="actions-header">Actions</th>
                    </tr>
                    <tr class="sub-header">
                        <th></th>
                        <th>Basic salary</th>
                        <th>Total allowances</th>
                        <th>Gross salary</th>
                        <th>RSSB EE</th>
                        <th>RSSB ER</th>
                        <th>Other deductions</th>
                        <th>PAYE</th>
                        <th>Net salary</th>
                        <th>Mass salary</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngIf="!loading; else skeletonRows">
                        <tr *ngFor="let employee of filteredPayrollEmployees">
                            <td class="employee-cell">
                                <div class="employee-info">
                                    <input type="checkbox" class="employee-checkbox">
                                    <div class="employee-details">
                                        <div class="employee-name">
                                            {{ employee.employee?.first_name }} {{ employee.employee?.last_name }}
                                            <i class="bi bi-chat-dots ms-1" *ngIf="employee.has_comments"></i>
                                            <i class="bi bi-plus-circle ms-1" *ngIf="!employee.has_comments"></i>
                                        </div>
                                        <div class="employee-phone">{{ employee.employee?.personal_mobile }}</div>
                                    </div>
                                </div>
                            </td>
                            <td>{{ employee.basic_salary | numberFormat }}</td>
                            <td>{{ employee.total_allowances | numberFormat }}</td>
                            <td>{{ employee.total_gross_salary | numberFormat }}</td>
                            <td>{{ employee.total_rssb_employee_deductions | numberFormat }}</td>
                            <td>{{ employee.total_rssb_employer_deductions | numberFormat }}</td>
                            <td>{{ employee.total_other_deductions | numberFormat }}</td>
                            <td>{{ employee.total_paye_deductions | numberFormat }}</td>
                            <td>{{ employee.total_net_salary | numberFormat }}</td>
                            <td>{{ employee.total_mass_salary | numberFormat }}</td>
                            <td class="actions-cell">
                                <button class="btn btn-sm btn-outline-primary detail-btn" 
                                        (click)="openEmployeeDetailsModal(employeeDetailsModal, employee)">
                                    Detail
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" 
                                        (click)="deletePayslipById(employee)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        <tr class="total-row">
                            <td>Total employees {{ filteredPayrollEmployees.length }}</td>
                            <td>{{ getTotalBasicSalary() | numberFormat }}</td>
                            <td>{{ getTotalAllowances() | numberFormat }}</td>
                            <td>{{ getTotalGrossSalary() | numberFormat }}</td>
                            <td>{{ getTotalRSSBEE() | numberFormat }}</td>
                            <td>{{ getTotalRSSBER() | numberFormat }}</td>
                            <td>{{ getTotalOtherDeductions() | numberFormat }}</td>
                            <td>{{ getTotalPAYE() | numberFormat }}</td>
                            <td>{{ getTotalNetSalary() | numberFormat }}</td>
                            <td>{{ getTotalMassSalary() | numberFormat }}</td>
                            <td></td>
                        </tr>
                    </ng-container>
                    <ng-template #skeletonRows>
                        <tr *ngFor="let _ of [].constructor(8)">
                            <td colspan="7">
                                <div class="skeleton-row d-flex">
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 15%;"></div>
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 12%;"></div>
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 12%;"></div>
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 12%;"></div>
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 12%;"></div>
                                    <div class="skeleton skeleton-text flex-fill me-2" style="width: 12%;"></div>
                                    <div class="skeleton skeleton-action" style="width: 8%; height: 2em;"></div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="pagination-section">
            <div class="pagination-info">
                Showing 1-{{ filteredPayrollEmployees.length }} of {{ filteredPayrollEmployees.length }} results
            </div>
            <!-- <div class="pagination-controls">
                <button class="btn btn-sm btn-outline-secondary">Previous</button>
                <button class="btn btn-sm btn-primary">01</button>
                <button class="btn btn-sm btn-outline-secondary">02</button>
                <button class="btn btn-sm btn-outline-secondary">03</button>
                <span class="pagination-dots">...</span>
                <button class="btn btn-sm btn-outline-secondary">07</button>
                <button class="btn btn-sm btn-outline-secondary">Next</button>
            </div> -->
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
            <button class="submit-btn" 
                    (click)="requestApproval()" 
                    *ngIf="details?.payroll_status == 1" 
                    [disabled]="loading"
                    [title]="'Request approval for payroll processing'">
                <i class="mdi mdi-send me-2"></i>
                <span *ngIf="!loading">Submit payroll →</span>
                <span *ngIf="loading">Processing...</span>
            </button>
            <a class="btn btn-secondary back-btn" [routerLink]="['/payroll/list']">
                <i class="mdi mdi-arrow-left me-1"></i> BACK
            </a>
        </div>

    </div>

</div>

<!-- Employee Details Modal -->
<ng-template #employeeDetailsModal>
    <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="bi bi-person-badge me-2"></i>Employee Payslip Details</h5>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" (click)="closeModal()">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="modal-body" *ngIf="selectedEmployee">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-2 text-primary"><i class="bi bi-person me-1"></i> Personal Info</h6>
                        <div class="mb-1"><i class="bi bi-person-circle me-1"></i><strong>Full Name:</strong> {{
                            selectedEmployee.employee?.first_name }} {{ selectedEmployee.employee?.last_name }}</div>
                        <div class="mb-1"><i class="bi bi-telephone me-1"></i><strong>Phone No:</strong> {{
                            selectedEmployee.employee?.personal_mobile }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-body p-3">
                        <h6 class="fw-bold mb-2 text-primary"><i class="bi bi-calendar-event me-1"></i> Payroll Info</h6>
                        <div class="mb-1"><i class="bi bi-calendar3 me-1"></i><strong>Payroll Date:</strong> {{
                            selectedEmployee.payroll_date | date:'yyyy-MM-dd' }}</div>
                        <div class="mb-1"><i class="bi bi-receipt me-1"></i><strong>Payslip No:</strong> {{
                            selectedEmployee.payslip_number || '-' }}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="table-responsive mb-3">
            <table class="table table-bordered align-middle mb-0">
                <tbody>
                    <tr>
                        <th class="bg-light"><i class="bi bi-cash-coin me-1" data-bs-toggle="tooltip"
                                title="Employee's base salary"></i> Basic Salary</th>
                        <td class="fw-bold text-primary">{{ selectedEmployee.basic_salary | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-gift me-1" data-bs-toggle="tooltip"
                                title="Total of all allowances"></i> Total Allowances</th>
                        <td class="fw-bold text-info">{{ selectedEmployee.total_allowances | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-graph-up-arrow me-1" data-bs-toggle="tooltip"
                                title="Gross salary before deductions"></i> Total Gross Salary</th>
                        <td class="fw-bold text-success fs-5">{{ selectedEmployee.total_gross_salary | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-person-dash me-1" data-bs-toggle="tooltip"
                                title="Employee's RSSB deduction"></i> Total RSSB EE</th>
                        <td class="fw-bold text-warning">{{ selectedEmployee.total_rssb_employee_deductions | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-building me-1" data-bs-toggle="tooltip"
                                title="Employer's RSSB contribution"></i> Total RSSB ER</th>
                        <td class="fw-bold text-warning">{{ selectedEmployee.total_rssb_employer_deductions | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-dash-circle me-1" data-bs-toggle="tooltip"
                                title="Other deductions (e.g. loans, penalties)"></i> Total Other Deduction</th>
                        <td class="fw-bold text-danger">{{ selectedEmployee.total_other_deductions | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-percent me-1" data-bs-toggle="tooltip"
                                title="PAYE (tax) deduction"></i> Total PAYE</th>
                        <td class="fw-bold text-danger">{{ selectedEmployee.total_paye_deductions | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-wallet2 me-1" data-bs-toggle="tooltip"
                                title="Net salary after all deductions"></i> Total Net Salary</th>
                        <td class="fw-bold text-success fs-5">{{ selectedEmployee.total_net_salary | numberFormat }}</td>
                    </tr>
                    <tr>
                        <th class="bg-light"><i class="bi bi-cash-stack me-1" data-bs-toggle="tooltip"
                                title="Total mass salary (if applicable)"></i> Total Mass Salary</th>
                        <td class="fw-bold text-dark">{{ selectedEmployee.total_mass_salary | numberFormat }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!-- RSSB Details Table -->
        <div *ngIf="selectedEmployee.rssb_details">
            <div class="mb-2 mt-3 fw-bold text-primary bg-light p-2 rounded"><i class="bi bi-bank me-1"></i> RSSB Details
            </div>
            <div class="table-responsive mb-3">
                <table class="table table-bordered align-middle mb-0">
                    <thead class="table-primary">
                        <tr>
                            <th>Name</th>
                            <th>Base</th>
                            <th>Employee Rate</th>
                            <th>Employer Rate</th>
                            <th>Employee Amount</th>
                            <th>Employer Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let rssb of selectedEmployee.rssb_details">
                            <td>{{ rssb.name }}</td>
                            <td>{{ rssb.base | numberFormat }}</td>
                            <td>{{ rssb.employee_contribution_rate | percent:'1.0-2' }}</td>
                            <td>{{ rssb.employer_contribution_rate | percent:'1.0-2' }}</td>
                            <td class="text-success fw-bold">{{ rssb.employee_contribution_amount | numberFormat }}</td>
                            <td class="text-info fw-bold">{{ rssb.employer_contribution_amount | numberFormat }}</td>
                        </tr>
                        <tr *ngIf="selectedEmployee.rssb_details.length">
                            <th class="text-end" colspan="4">Total</th>
                            <th class="text-success fw-bold">
                                {{ getRssbEmployeeTotal() | numberFormat }}
                            </th>
                            <th class="text-info fw-bold">
                                {{ getRssbEmployerTotal() | numberFormat }}
                            </th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Allowances Details Table -->
        <div *ngIf="selectedEmployee.allowance_details">
            <div class="mb-2 mt-3 fw-bold text-info bg-info-subtle p-2 rounded"><i class="bi bi-gift me-1"></i> Allowances
                Details</div>
            <div class="table-responsive mb-3">
                <table class="table table-bordered align-middle mb-0">
                    <thead class="table-info">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Rate/Amount</th>
                            <th>Calculated Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let allowance of selectedEmployee.allowance_details">
                            <td>{{ allowance.name }}</td>
                            <td>{{ allowance.type }}</td>
                            <td>{{ allowance.rate_or_amount | numberFormat }}</td>
                            <td class="text-success fw-bold">{{ allowance.calculated_amount | numberFormat }}</td>
                        </tr>
                        <tr *ngIf="selectedEmployee.allowance_details.length" class="bg-info-subtle">
                            <th class="text-end" colspan="3">Total</th>
                            <th class="text-success fw-bold">
                                {{ getAllowanceTotal() | number:'1.0-2' }}
                            </th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Other Deductions Details Table -->
        <div *ngIf="selectedEmployee.other_deduction_details">
            <div class="mb-2 fw-bold text-danger bg-danger-subtle p-2 rounded"><i class="bi bi-dash-circle me-1"></i> Other
                Deductions Details</div>
            <div class="table-responsive mb-3">
                <table class="table table-bordered align-middle mb-0">
                    <thead class="table-danger">
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Rate/Amount</th>
                            <th>Calculated Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let deduction of selectedEmployee.other_deduction_details">
                            <td>{{ deduction.name }}</td>
                            <td>{{ deduction.type }}</td>
                            <td>{{ deduction.rate_or_amount | number:'1.0-2' }}</td>
                            <td class="text-danger fw-bold">{{ deduction.calculated_amount | number:'1.0-2' }}</td>
                        </tr>
                        <tr *ngIf="selectedEmployee.other_deduction_details.length" class="bg-primary-subtle">
                            <th class="text-end" colspan="3">Total</th>
                            <th class="text-danger fw-bold">
                                {{ getOtherDeductionTotal() | number:'1.0-2' }}
                            </th>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary text-black" (click)="closeModal()">Close</button>
    </div>
</ng-template>

</ng-container>
