<div class="container-fluid">
  <!-- Page title -->
  <div class="row">
    <div class="col-12">
      <div class="page-title-box d-sm-flex align-items-center justify-content-between">
        <h4 class="mb-sm-0">Time Off Types</h4>
      </div>
    </div>
  </div>

  <!-- Access Denied Message -->
  <div class="row" *ngIf="!hasAnyTimeOffTypePermission()">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center">
          <div class="alert alert-warning" role="alert">
            <i class="mdi mdi-alert-circle font-size-24 me-2"></i>
            <strong>Access Denied</strong>
            <p class="mb-0 mt-2">You don't have permission to access the Time Off Types module.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Off Types Management Content -->
  <div class="row" *ngIf="hasAnyTimeOffTypePermission()">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <!-- Skeleton Loader -->
          <div *ngIf="isLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading time off types...</p>
          </div>
          <!-- Main Content: Only show when not loading -->
          <ng-container *ngIf="!isLoading">
            <div class="row mb-2">
              <div class="col-sm-4">
                <div class="search-box me-2 mb-2 d-inline-block">
                  <div class="position-relative">
                    <input type="text" class="form-control" autocomplete="off" id="searchTableList" placeholder="Search time off types..." [(ngModel)]="term" (ngModelChange)="searchTimeOffTypes()">
                    <i class="bx bx-search-alt search-icon"></i>
                  </div>
                </div>
              </div>
              <div class="col-sm-8">
                <div class="text-sm-end">
                  <button type="button" class="btn btn-primary btn-rounded mb-2 me-2" 
                          (click)="openModal(timeOffTypeModal)"
                          *ngIf="canCreateTimeOffType()">
                    <i class="mdi mdi-plus mr-1"></i> Add New Time Off Type
                  </button>
                </div>
              </div>
            </div>
            <!-- Table data -->
            <div class="table-responsive mb-0" *ngIf="canViewTimeOffTypes()">
              @if(error) {
                <div class="alert alert-danger" role="alert">
                  {{ error }}
                  <button type="button" class="btn btn-primary mt-2" (click)="loadTimeOffTypes()">Try Again</button>
                </div>
              } @else if(timeOffTypes.length === 0) {
                <div class="text-center py-4">
                  <p>No time off types found.</p>
                  <button type="button" class="btn btn-primary" 
                          (click)="openModal(timeOffTypeModal)"
                          *ngIf="canCreateTimeOffType()">
                    <i class="mdi mdi-plus mr-1"></i> Add New Time Off Type
                  </button>
                </div>
              } @else {
                <table class="table align-middle table-nowrap dt-responsive nowrap w-100 table-check" id="time-off-type-list">
                  <thead class="table-light">
                    <tr>
                      <th class="align-middle">Name</th>
                      <th class="align-middle">Code</th>
                      <th class="align-middle">Description</th>
                      <th class="align-middle">Kind</th>
                      <th class="align-middle">Is Paid</th>
                      <th class="align-middle">Take Time Off In</th>
                      <th class="align-middle">Approval Type</th>
                      <th class="align-middle">Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (timeOffType of timeOffTypes; track $index) {
                    <tr id="t_{{timeOffType.id}}">
                      <td>
                        <a href="javascript: void(0);" class="text-body">{{timeOffType.name}}</a>
                      </td>
                      <td>
                        <span class="badge badge-pill badge-soft-primary font-size-11">{{timeOffType.code}}</span>
                      </td>
                      <td>{{timeOffType.description}}</td>
                      <td>
                        <span class="badge badge-pill badge-soft-info font-size-11" *ngIf="timeOffType.kind">
                          {{timeOffType.kind.name}}
                        </span>
                        <span class="badge badge-pill badge-soft-info font-size-11" *ngIf="!timeOffType.kind && timeOffType.kind_id">
                          {{getKindName(timeOffType.kind_id)}}
                        </span>
                        <span class="text-muted" *ngIf="!timeOffType.kind && !timeOffType.kind_id">-</span>
                      </td>
                      <td>
                        <span class="badge badge-pill badge-soft-success font-size-11" [ngClass]="{'badge-soft-danger': !timeOffType.is_paid}">
                          {{timeOffType.is_paid ? 'Yes' : 'No'}}
                        </span>
                      </td>
                      <td>{{getTakeTimeOffInLabel(timeOffType.take_time_off_in)}}</td>
                      <td>{{getApprovalTypeLabel(timeOffType.approval_type)}}</td>
                      <td>
                        <div class="d-flex gap-2">
                          <button type="button" class="btn btn-primary btn-sm btn-rounded" (click)="openViewModal(ViewContent, timeOffType)">View Details</button>
                          <button type="button" class="btn btn-success btn-sm btn-rounded ms-1" 
                                  (click)="openModal(timeOffTypeModal, timeOffType)"
                                  *ngIf="canUpdateTimeOffType()">
                            <i class="mdi mdi-pencil font-size-16"></i>
                          </button>
                          <button type="button" class="btn btn-danger btn-sm btn-rounded ms-1" 
                                  (click)="confirm(timeOffType.id, removeItemModal)"
                                  *ngIf="canDeleteTimeOffType()">
                            <i class="mdi mdi-delete font-size-16"></i>
                          </button>
                        </div>
                      </td>
                    </tr>}
                  </tbody>
                </table>
              }
            </div>

            <!-- No View Permission Message -->
            <div *ngIf="!canViewTimeOffTypes()" class="text-center">
              <div class="alert alert-info" role="alert">
                <i class="mdi mdi-information font-size-24 me-2"></i>
                <strong>No View Permission</strong>
                <p class="mb-0 mt-2">You don't have permission to view time off types.</p>
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Details Modal -->
<ng-template #ViewContent let-modal>
  <div class="modal-header">
    <h5 class="modal-title mt-0" id="timeOffTypeDetailsModalLabel">Time Off Type Details</h5>
    <button type="button" class="btn-close" aria-hidden="true" (click)="modalRef?.close()"></button>
  </div>
  <div class="modal-body">
    <div class="table-responsive">
      <table class="table table-centered table-nowrap">
        <tbody>
          <tr>
            <td><strong>Name:</strong></td>
            <td>{{selectedTimeOffType?.name}}</td>
          </tr>
          <tr>
            <td><strong>Code:</strong></td>
            <td><span class="badge badge-pill badge-soft-primary">{{selectedTimeOffType?.code}}</span></td>
          </tr>
          <tr>
            <td><strong>Description:</strong></td>
            <td>{{selectedTimeOffType?.description}}</td>
          </tr>
          <tr>
            <td><strong>Kind:</strong></td>
            <td>
              <span *ngIf="selectedTimeOffType?.kind">
                <strong>{{selectedTimeOffType.kind.name}}</strong><br>
                <small class="text-muted">{{selectedTimeOffType.kind.description}}</small>
              </span>
              <span class="text-muted" *ngIf="!selectedTimeOffType?.kind">{{selectedTimeOffType?.kind_id}}</span>
            </td>
          </tr>
          <tr>
            <td><strong>Is Paid:</strong></td>
            <td>
              <span class="badge badge-pill badge-soft-success" [ngClass]="{'badge-soft-danger': !selectedTimeOffType?.is_paid}">
                {{selectedTimeOffType?.is_paid ? 'Yes' : 'No'}}
              </span>
            </td>
          </tr>
          <tr>
            <td><strong>Take Time Off In:</strong></td>
            <td>{{getTakeTimeOffInLabel(selectedTimeOffType?.take_time_off_in)}}</td>
          </tr>
          <tr>
            <td><strong>Require Supporting Document:</strong></td>
            <td>
              <span class="badge badge-pill badge-soft-success" [ngClass]="{'badge-soft-danger': !selectedTimeOffType?.require_supporting_document}">
                {{selectedTimeOffType?.require_supporting_document ? 'Yes' : 'No'}}
              </span>
            </td>
          </tr>
          <tr>
            <td><strong>Requires Allocation:</strong></td>
            <td>
              <span class="badge badge-pill badge-soft-success" [ngClass]="{'badge-soft-danger': !selectedTimeOffType?.requires_allocation}">
                {{selectedTimeOffType?.requires_allocation ? 'Yes' : 'No'}}
              </span>
            </td>
          </tr>
          <tr>
            <td><strong>Approval Type:</strong></td>
            <td>{{getApprovalTypeLabel(selectedTimeOffType?.approval_type)}}</td>
          </tr>
          <tr>
            <td><strong>Created At:</strong></td>
            <td>{{selectedTimeOffType?.created_at | date:'medium'}}</td>
          </tr>
          <tr>
            <td><strong>Updated At:</strong></td>
            <td>{{selectedTimeOffType?.updated_at | date:'medium'}}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-secondary" (click)="modalRef?.close()">Close</button>
  </div>
</ng-template>

<!-- Add/Edit Time Off Type Modal -->
<ng-template #timeOffTypeModal>
  <div class="modal-header">
    <h5 class="modal-title">
      <i class="mdi" [ngClass]="isEdit ? 'mdi-pencil' : 'mdi-plus'"></i>
      {{isEdit ? 'Edit' : 'Add'}} Time Off Type
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="modalService.dismissAll()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="timeOffTypeForm" (ngSubmit)="onSubmit()" class="needs-validation" novalidate>
      <div class="row">
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="name-field" class="form-label">Name <span class="text-danger">*</span></label>
            <input type="text" id="name-field" class="form-control" placeholder="Enter time off type name" required formControlName="name" [ngClass]="{ 'is-invalid': submitted && f['name'].errors }" />
            @if(submitted && f['name'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['name'].errors['required']){
              <div>Please enter a name.</div>}
            </div>}
          </div>
        </div>
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="code-field" class="form-label">Code <span class="text-danger">*</span></label>
            <input type="text" id="code-field" class="form-control" placeholder="Enter code (e.g., AL)" required formControlName="code" [ngClass]="{ 'is-invalid': submitted && f['code'].errors }" />
            @if(submitted && f['code'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['code'].errors['required']){
              <div>Please enter a code.</div>}
            </div>}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
          <div class="mb-3">
            <label for="description-field" class="form-label">Description <span class="text-danger">*</span></label>
            <textarea id="description-field" class="form-control" rows="3" placeholder="Enter description" required formControlName="description" [ngClass]="{ 'is-invalid': submitted && f['description'].errors }"></textarea>
            @if(submitted && f['description'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['description'].errors['required']){
              <div>Please enter a description.</div>}
            </div>}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="kind-id-field" class="form-label">Kind of Time Off <span class="text-danger">*</span></label>
            <ng-select
              [items]="timeOffKinds"
              bindLabel="name"
              bindValue="id"
              placeholder="Select a kind"
              formControlName="kind_id"
              [ngClass]="{ 'is-invalid': submitted && f['kind_id'].errors }">
              <ng-template ng-option-tmp let-item="item">
                <strong>{{item.name}}</strong><br>
                <small class="text-muted">{{item.description}}</small>
              </ng-template>
            </ng-select>
            @if(submitted && f['kind_id'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['kind_id'].errors['required']){
              <div>Please select a kind.</div>}
            </div>}
          </div>
        </div>
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="take-time-off-in-field" class="form-label">Take Time Off In <span class="text-danger">*</span></label>
            <ng-select
              [items]="takeTimeOffInOptions"
              bindLabel="label"
              bindValue="value"
              placeholder="Select time off unit"
              formControlName="take_time_off_in"
              [ngClass]="{ 'is-invalid': submitted && f['take_time_off_in'].errors }">
            </ng-select>
            @if(submitted && f['take_time_off_in'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['take_time_off_in'].errors['required']){
              <div>Please select a time off unit.</div>}
            </div>}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="approval-type-field" class="form-label">Approval Type <span class="text-danger">*</span></label>
            <ng-select
              [items]="approvalTypeOptions"
              bindLabel="label"
              bindValue="value"
              placeholder="Select approval type"
              formControlName="approval_type"
              [ngClass]="{ 'is-invalid': submitted && f['approval_type'].errors }">
            </ng-select>
            @if(submitted && f['approval_type'].errors){
            <div class="invalid-feedback" align="left">
              @if(f['approval_type'].errors['required']){
              <div>Please select an approval type.</div>}
            </div>}
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="is-paid-field" formControlName="is_paid">
              <label class="form-check-label" for="is-paid-field">Is Paid</label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="require-supporting-document-field" formControlName="require_supporting_document">
              <label class="form-check-label" for="require-supporting-document-field">Require Supporting Document</label>
            </div>
          </div>
          <div class="mb-3">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="requires-allocation-field" formControlName="requires_allocation">
              <label class="form-check-label" for="requires-allocation-field">Requires Allocation</label>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-light" (click)="modalService.dismissAll()">Close</button>
        <button type="submit" class="btn btn-primary" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          {{ isEdit ? (saving ? 'Updating...' : 'Update') : (saving ? 'Creating...' : 'Create') }}
        </button>
      </div>
    </form>
  </div>
</ng-template>

<!-- Delete Confirmation Modal -->
<ng-template #removeItemModal>
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-body px-4 py-5 text-center">
        <button type="button" class="btn-close position-absolute end-0 top-0 m-3" (click)="modalService.dismissAll()"></button>
        <div class="avatar-sm mb-4 mx-auto">
          <div class="avatar-title bg-primary text-primary bg-opacity-10 font-size-20 rounded-3">
            <i class="mdi mdi-trash-can-outline"></i>
          </div>
        </div>
        <p class="text-muted font-size-16 mb-4">Are you sure you want to remove this time off type?</p>

        <div class="hstack gap-2 justify-content-center mb-0">
          <button type="button" class="btn btn-danger" id="remove-item" (click)="deleteTimeOffType(selectedTimeOffTypeId)" [disabled]="deleteLoading">
            <span *ngIf="deleteLoading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            {{ deleteLoading ? 'Removing...' : 'Remove Now' }}
          </button>
          <button type="button" class="btn btn-secondary" id="close-removeOrderModal" (click)="modalService.dismissAll()">Close</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>
