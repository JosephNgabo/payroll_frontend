<div class="container-fluid">
    <app-page-title title="Employee Management" [breadcrumbItems]="breadCrumbItems"></app-page-title>
  
    <!-- Loading State -->
    <div *ngIf="isLoading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading employee form...</p>
    </div>
  
    <!-- Start Form Wizard Basic row -->
    <div class="row" *ngIf="!isLoading">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-4">Employee Creation</h4>
            <div id="basic-example">
              <ng-stepper #cdkStepper [linear]="true" class="wizard">
  
                <!-- Step 1: Basic Info -->
                <cdk-step [optional]="false">
                  <ng-template cdkStepLabel>
                    <span class="number">1.</span>
                    <span>Personal Info</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 0">
                    <form [formGroup]="basicInfoForm" novalidate>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>First Name</label>
                          <input type="text" class="form-control" formControlName="firstName" placeholder="Enter First Name"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.firstName.errors, 'is-valid': submittedBasicInfo && basicInfo.firstName.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.firstName.errors">
                            <span *ngIf="basicInfo.firstName.errors.required">First name is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Last Name</label>
                          <input type="text" class="form-control" formControlName="lastName" placeholder="Enter Last Name"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.lastName.errors, 'is-valid': submittedBasicInfo && basicInfo.lastName.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.lastName.errors">
                            <span *ngIf="basicInfo.lastName.errors.required">Last name is required.</span>
                          </div>
                        </div>
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Name of Spouse</label>
                          <input type="text" class="form-control" formControlName="spouseName" placeholder="Enter Name of Spouse">
                        </div>
                        -->
                        <div class="col-lg-4 mb-3">
                          <label>Gender</label>
                          <ng-select [items]="genders"
                                     bindLabel="label"
                                     bindValue="value"
                                     formControlName="gender"
                                     placeholder="Select Gender"
                                     [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.gender.errors, 'is-valid': submittedBasicInfo && basicInfo.gender.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedBasicInfo && basicInfo.gender.errors">
                            <span *ngIf="basicInfo.gender.errors.required">Gender is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <!-- <div class="col-lg-4 mb-3">
                          <label>Gender</label>
                          <ng-select [items]="genders"
                                     bindLabel="label"
                                     bindValue="value"
                                     formControlName="gender"
                                     placeholder="Select Gender"
                                     [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.gender.errors, 'is-valid': submittedBasicInfo && basicInfo.gender.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedBasicInfo && basicInfo.gender.errors">
                            <span *ngIf="basicInfo.gender.errors.required">Gender is required.</span>
                          </div>
                        </div> -->
                        <!-- <div class="col-lg-4 mb-3">
                          <label>Date of Birth</label>
                          <input type="date" class="form-control" formControlName="dateOfBirth"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.dateOfBirth.errors, 'is-valid': submittedBasicInfo && basicInfo.dateOfBirth.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.dateOfBirth.errors">
                            <span *ngIf="basicInfo.dateOfBirth.errors.required">Date of birth is required.</span>
                          </div>
                        </div> -->
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Number of Children</label>
                          <input type="number" class="form-control" formControlName="numberOfChildren" min="0" placeholder="Enter Number of Children"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.numberOfChildren.errors, 'is-valid': submittedBasicInfo && basicInfo.numberOfChildren.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.numberOfChildren.errors">
                            <span *ngIf="basicInfo.numberOfChildren.errors.min">Value must be 0 or greater.</span>
                          </div>
                        </div>
                        -->
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Date of Birth</label>
                          <input type="date" class="form-control" formControlName="dateOfBirth"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.dateOfBirth.errors, 'is-valid': submittedBasicInfo && basicInfo.dateOfBirth.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.dateOfBirth.errors">
                            <span *ngIf="basicInfo.dateOfBirth.errors.required">Date of birth is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Nationality</label>
                          <ng-select *ngIf="countries && countries.length"
                                     [items]="countries"
                                     bindLabel="country"
                                     bindValue="id"
                                     formControlName="nationality"
                                     placeholder="Select Nationality"
                                     [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.nationality.errors, 'is-valid': submittedBasicInfo && basicInfo.nationality.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedBasicInfo && basicInfo.nationality.errors">
                            <span *ngIf="basicInfo.nationality.errors.required">Nationality is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Country of Birth</label>
                          <ng-select *ngIf="countries && countries.length"
                                     [items]="countries"
                                     bindLabel="country"
                                     bindValue="id"
                                     formControlName="countryOfBirth"
                                     placeholder="Select Country of Birth"
                                     [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.countryOfBirth.errors, 'is-valid': submittedBasicInfo && basicInfo.countryOfBirth.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedBasicInfo && basicInfo.countryOfBirth.errors">
                            <span *ngIf="basicInfo.countryOfBirth.errors.required">Country of birth is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Marital Status</label>
                          <ng-select [items]="['single', 'married', 'widowed', 'divorced', 'separated']"
                                     formControlName="maritalStatus"
                                     placeholder="Select Marital Status"
                                     [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.maritalStatus.errors, 'is-valid': submittedBasicInfo && basicInfo.maritalStatus.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedBasicInfo && basicInfo.maritalStatus.errors">
                            <span *ngIf="basicInfo.maritalStatus.errors.required">Marital status is required.</span>
                          </div>
                        </div>
                      </div>
                      <hr/>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Personal Mobile</label>
                          <input type="text" class="form-control" formControlName="personalMobile" placeholder="Enter Personal Mobile"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.personalMobile.errors, 'is-valid': submittedBasicInfo && basicInfo.personalMobile.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.personalMobile.errors"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Personal Email</label>
                          <input type="email" class="form-control" formControlName="personalEmail" placeholder="Enter Personal Email"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.personalEmail.errors, 'is-valid': submittedBasicInfo && basicInfo.personalEmail.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.personalEmail.errors">
                            <span *ngIf="basicInfo.personalEmail.errors.email">Please enter a valid email address.</span>
                          </div>
                        </div>
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Home Phone</label>
                          <input type="text" class="form-control" formControlName="homePhone" placeholder="Enter Home Phone"
                                 [ngClass]="{'is-invalid': submittedBasicInfo && basicInfo.homePhone.errors, 'is-valid': submittedBasicInfo && basicInfo.homePhone.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBasicInfo && basicInfo.homePhone.errors"></div>
                        </div>
                        -->
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="list-inline-item">
                          <button class="btn btn-secondary" [routerLink]="['/employees/employees-view']">
                            <i class="mdi mdi-arrow-left me-1"></i> Back
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[0]" class="btn btn-primary" type="button" (click)="onEditStep(0)">Edit</button>
                          <button *ngIf="isEditingStep[0]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(0)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[0]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(0)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>
  
                <!-- Step 2: Legal & Contacts Info -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">2.</span>
                    <span>Legal Info</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 1">
                    <form *ngIf="legalContactsInfoForm" [formGroup]="legalContactsInfoForm" (ngSubmit)="onLegalContactsInfoSubmit()" novalidate>
                      <!-- Legal Info Fields -->
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Document Type</label>
                          <ng-select [items]="legalDocumentTypes"
                                     bindLabel="label"
                                     bindValue="value"
                                     formControlName="documentType"
                                     placeholder="Select Document Type"
                                     [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.documentType.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.documentType.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentType.errors">
                            <span *ngIf="legalContactsInfo.documentType.errors.required">Document type is required.</span>
                          </div>
                          <div class="valid-feedback d-block" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentType.valid"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Document Number</label>
                          <input type="text" class="form-control" formControlName="documentNumber" placeholder="Enter Document Number"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.documentNumber.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.documentNumber.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentNumber.errors">
                          </div>
                          <div class="valid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentNumber.valid"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Document Issue Date</label>
                          <input type="date" class="form-control" formControlName="documentIssueDate"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.documentIssueDate.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.documentIssueDate.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentIssueDate.errors">
                          </div>
                          <div class="valid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentIssueDate.valid"></div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Document Expiry Date</label>
                          <input type="date" class="form-control" formControlName="documentExpiryDate"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.documentExpiryDate.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.documentExpiryDate.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentExpiryDate.errors">
                          </div>
                          <div class="valid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.documentExpiryDate.valid"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Place of Issue</label>
                          <input type="text" class="form-control" formControlName="placeOfIssue" placeholder="Enter Place of Issue">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.placeOfIssue.errors"></div>
                          <div class="valid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.placeOfIssue.valid"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>RSSB Number</label>
                          <input type="text" class="form-control" formControlName="rssbNumber" placeholder="Enter RSSB Number"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.rssbNumber.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.rssbNumber.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.rssbNumber.errors">
                            <span *ngIf="legalContactsInfo.rssbNumber.errors.required">RSSB number is required.</span>
                          </div>
                          <div class="valid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.rssbNumber.valid"></div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Highest Education</label>
                          <ng-select [items]="['Secondary', 'Bachelor', 'Master', 'PhD', 'Other']"
                                     formControlName="highestEducation"
                                     placeholder="Select Highest Education"
                                     [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.highestEducation.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.highestEducation.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedLegalContactsInfo && legalContactsInfo.highestEducation.errors">
                            <span *ngIf="legalContactsInfo.highestEducation.errors.required">Highest education is required.</span>
                          </div>
                          <div class="valid-feedback d-block" *ngIf="submittedLegalContactsInfo && legalContactsInfo.highestEducation.valid"></div>
                        </div>
                      </div>
                      <hr/>
                      <!-- Contact Info Fields -->
                      <!-- <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Personal Mobile</label>
                          <input type="text" class="form-control" formControlName="personalMobile" placeholder="Enter Personal Mobile"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.personalMobile.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.personalMobile.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.personalMobile.errors"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Personal Email</label>
                          <input type="email" class="form-control" formControlName="personalEmail" placeholder="Enter Personal Email"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.personalEmail.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.personalEmail.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.personalEmail.errors">
                            <span *ngIf="legalContactsInfo.personalEmail.errors.email">Please enter a valid email address.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Home Phone</label>
                          <input type="text" class="form-control" formControlName="homePhone" placeholder="Enter Home Phone"
                                 [ngClass]="{'is-invalid': submittedLegalContactsInfo && legalContactsInfo.homePhone.errors, 'is-valid': submittedLegalContactsInfo && legalContactsInfo.homePhone.valid}">
                          <div class="invalid-feedback" *ngIf="submittedLegalContactsInfo && legalContactsInfo.homePhone.errors"></div>
                        </div>
                      </div> -->
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[1]" class="btn btn-primary" type="button" (click)="onEditStep(1)">Edit</button>
                          <button *ngIf="isEditingStep[1]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(1)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[1]" class="btn btn-secondary" type="button" (click)="onCancelEditStep(1)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>
  
                <!-- Step 3: Contract Info -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">3.</span>
                    <span>Contract</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 2">
                    <form [formGroup]="contractInfoForm" novalidate>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Department <span class="text-danger">*</span></label>
                          <ng-select [items]="departments"
                                     bindLabel="name"
                                     bindValue="id"
                                     formControlName="department"
                                     placeholder="Select Department"
                                     [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.department.errors, 'is-valid': submittedContractInfo && contractInfo.department.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedContractInfo && contractInfo.department.errors">
                            <span *ngIf="contractInfo.department.errors.required">Department is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Job Title <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" formControlName="job_title" placeholder="Enter Job Title"
                                 [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.job_title.errors, 'is-valid': submittedContractInfo && contractInfo.job_title.valid}">
                          <div class="invalid-feedback" *ngIf="submittedContractInfo && contractInfo.job_title.errors">
                            <span *ngIf="contractInfo.job_title.errors.required">Job title is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Employment Type <span class="text-danger">*</span></label>
                          <ng-select [items]="['permanent', 'contract', 'internship', 'consultant']"
                                     formControlName="employment_type"
                                     placeholder="Select Employment Type"
                                     [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.employment_type.errors, 'is-valid': submittedContractInfo && contractInfo.employment_type.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedContractInfo && contractInfo.employment_type.errors">
                            <span *ngIf="contractInfo.employment_type.errors.required">Employment type is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Hire Date <span class="text-danger">*</span></label>
                          <input type="date" class="form-control" formControlName="hire_date"
                                 [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.hire_date.errors, 'is-valid': submittedContractInfo && contractInfo.hire_date.valid}">
                          <div class="invalid-feedback" *ngIf="submittedContractInfo && contractInfo.hire_date.errors">
                            <span *ngIf="contractInfo.hire_date.errors.required">Hire date is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>End Date</label>
                          <input type="date" class="form-control" formControlName="end_date">
                        </div>
                        <!-- Salary Basis: show ng-select when editing, input when not editing -->
                        <div class="col-lg-4 mb-3">
                          <label>Salary Basis <span class="text-danger">*</span></label>
                          <ng-container *ngIf="isEditingStep[2]; else salaryBasisReadOnly">
                            <ng-select [items]="salaryBasisOptions"
                                       bindLabel="label"
                                       bindValue="value"
                                       formControlName="salary_basis"
                                       placeholder="Select Salary Basis"
                                       [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.salary_basis.errors, 'is-valid': submittedContractInfo && contractInfo.salary_basis.valid}">
                            </ng-select>
                            <div class="invalid-feedback d-block" *ngIf="submittedContractInfo && contractInfo.salary_basis.errors">
                              <span *ngIf="contractInfo.salary_basis.errors.required">Salary basis is required.</span>
                            </div>
                          </ng-container>
                          <ng-template #salaryBasisReadOnly>
                            <input type="text" class="form-control" [value]="getSalaryBasisLabel(contractInfoForm.value.salary_basis)" readonly>
                          </ng-template>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Salary Amount <span class="text-danger">*</span></label>
                          <input type="number" class="form-control" formControlName="salary_amount" min="0" step="0.01" placeholder="Enter Salary Amount"
                                 [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.salary_amount.errors, 'is-valid': submittedContractInfo && contractInfo.salary_amount.valid}">
                          <div class="invalid-feedback" *ngIf="submittedContractInfo && contractInfo.salary_amount.errors">
                            <span *ngIf="contractInfo.salary_amount.errors.required">Salary amount is required.</span>
                            <span *ngIf="contractInfo.salary_amount.errors.min">Value must be 0 or greater.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Salary Frequency <span class="text-danger">*</span></label>
                          <ng-select [items]="['monthly', 'hourly', 'bi-weekly']"
                                     formControlName="salary_frequency"
                                     placeholder="Select Salary Frequency"
                                     [ngClass]="{'is-invalid': submittedContractInfo && contractInfo.salary_frequency.errors, 'is-valid': submittedContractInfo && contractInfo.salary_frequency.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedContractInfo && contractInfo.salary_frequency.errors">
                            <span *ngIf="contractInfo.salary_frequency.errors.required">Salary frequency is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>TIN Number</label>
                          <input type="text" class="form-control" formControlName="tin_number" placeholder="Enter TIN Number">
                        </div>
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[2]" class="btn btn-primary" type="button" (click)="onEditStep(2)">Edit</button>
                          <button *ngIf="isEditingStep[2]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(2)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[2]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(2)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>
  
                <!-- Step 4: Allowance & Deductions (merged) -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">4.</span>
                    <span>Salary Items</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 3">
                    <!-- Allowance Section -->
                    <div class="card mb-4">
                      <div class="card-header bg-success text-white fw-bold d-flex justify-content-between align-items-center">
                        <span>Allowances</span>
                        <button class="btn btn-primary btn-sm" (click)="openAddAllowanceModal()" type="button" [disabled]="!isEditingStep[3]">+ Add Allowance</button>
                      </div>
                      <div class="card-body">
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>Name</th>
                              <th>Amount</th>
                              <th>Type</th>
                              <!-- <th>Allowance</th> -->
                              <!-- <th>Description</th> -->
                              <!-- <th>Action</th> -->
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let allowance of employeeAllowances; let i = index">
                              <td>{{ allowance.allowance_name }}</td>
                              <td>{{ allowance.amount }}</td>
                              <td>{{ allowance.type }}</td>
                              <!-- <td>{{ allowance.allowance_name }}</td> -->
                              <td>{{ allowance.description }}</td>
                              <td>
                                <button class="btn btn-danger btn-sm" (click)="removeAllowance(i)" type="button" [disabled]="!isEditingStep[3]">Remove</button>
                              </td>
                            </tr>
                            <tr *ngIf="employeeAllowances && employeeAllowances.length === 0">
                              <td colspan="6" class="text-center">No allowances added.</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>

                    <!-- Add Allowance Modal -->
                    <ng-template #addAllowanceModal>
                      <div class="modal-header">
                        <h5 class="modal-title">Add Allowance</h5>
                        <button type="button" class="btn-close" (click)="closeAddAllowanceModal()"></button>
                      </div>
                      <div class="modal-body">
                        <form [formGroup]="allowanceForm" (ngSubmit)="onAllowanceSubmit()" novalidate>
                          <div class="row">
                            <div class="col-lg-4 mb-3">
                              <label>Name</label>
                              <input type="text" class="form-control" formControlName="name" placeholder="Enter Allowance Name (optional)">
                            </div>
                            <div class="col-lg-4 mb-3">
                              <label>Amount <span class="text-danger">*</span></label>
                              <input type="number" class="form-control" formControlName="amount" min="0" step="0.01" placeholder="Enter Amount"
                                     [ngClass]="{'is-invalid': submittedAllowance && allowance.amount.errors, 'is-valid': submittedAllowance && allowance.amount.valid}">
                              <div class="invalid-feedback" *ngIf="submittedAllowance && allowance.amount.errors">
                                <span *ngIf="allowance.amount.errors.required">Amount is required.</span>
                                <span *ngIf="allowance.amount.errors.min">Value must be 0 or greater.</span>
                              </div>
                            </div>
                            <div class="col-lg-4 mb-3">
                              <label>Type <span class="text-danger">*</span></label>
                              <ng-select [items]="['fixed', 'percentage']"
                                         formControlName="type"
                                         placeholder="Select Type"
                                         [ngClass]="{'is-invalid': submittedAllowance && allowance.type.errors, 'is-valid': submittedAllowance && allowance.type.valid}">
                              </ng-select>
                              <div class="invalid-feedback d-block" *ngIf="submittedAllowance && allowance.type.errors">
                                <span *ngIf="allowance.type.errors.required">Type is required.</span>
                              </div>
                            </div>
                            <div class="col-lg-4 mb-3">
                              <label>Allowance <span class="text-danger">*</span></label>
                              <ng-select [items]="allowances"
                                         bindLabel="name"
                                         bindValue="id"
                                         formControlName="allowance_id"
                                         placeholder="Select Allowance"
                                         [ngClass]="{'is-invalid': submittedAllowance && allowance.allowance_id.errors, 'is-valid': submittedAllowance && allowance.allowance_id.valid}">
                              </ng-select>
                              <div class="invalid-feedback d-block" *ngIf="submittedAllowance && allowance.allowance_id.errors">
                                <span *ngIf="allowance.allowance_id.errors.required">Allowance is required.</span>
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-lg-4 mb-3">
                              <label>Description</label>
                              <input type="text" class="form-control" formControlName="description" placeholder="Enter Description (optional)">
                            </div>
                          </div>
                          <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" (click)="closeAddAllowanceModal()">Cancel</button>
                            <button class="btn btn-primary" type="submit" [disabled]="saving">
                              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                              Add Allowance
                            </button>
                          </div>
                        </form>
                      </div>
                    </ng-template>

                    <!-- Deductions Section (copy from Deductions step) -->
                    <div class="card mb-4">
                      <div class="card-header bg-warning text-dark fw-bold">Deductions</div>
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h5>RSSB Deductions</h5>
                          <button class="btn btn-primary" (click)="openAddRssbDeductionModal()" type="button" [disabled]="!isEditingStep[3]">+ Add Deduction</button>
                        </div>
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>Deduction Name</th>
                              <th>Employee Contribution</th>
                              <th>Employer Contribution</th>
                              <th>Description</th>
                              <th>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let deduction of employeeRssbDeductions; let i = index">
                              <td>{{ deduction.rssb_name }}</td>
                              <td>{{ deduction.rssb_employee_contribution }}</td>
                              <td>{{ deduction.rssb_employer_contribution }}</td>
                              <td>{{ deduction.rssb_description }}</td>
                              <td>
                                <button class="btn btn-danger btn-sm" (click)="removeRssbDeduction(i)" type="button" [disabled]="!isEditingStep[3]">Remove</button>
                              </td>
                            </tr>
                            <tr *ngIf="employeeRssbDeductions && employeeRssbDeductions.length === 0">
                              <td colspan="4" class="text-center">No RSSB deductions added.</td>
                            </tr>
                          </tbody>
                        </table>
                        <!-- Add RSSB Deduction Modal (unchanged) -->
                        <ng-template #addRssbDeductionModal>
                          <div class="modal-header">
                            <h5 class="modal-title">Add RSSB Deduction</h5>
                            <button type="button" class="btn-close" (click)="closeAddRssbDeductionModal()"></button>
                          </div>
                          <div class="modal-body">
                            <form [formGroup]="addRssbDeductionForm">
                              <div class="mb-3">
                                <label>Deduction</label>
                                <ng-select [items]="rssbDeductions"
                                           bindLabel="rssb_name"
                                           bindValue="id"
                                           formControlName="rssb_deduction_id"
                                           placeholder="Select RSSB Deduction"
                                           (change)="onRssbDeductionSelected()">
                                </ng-select>
                              </div>
                              <div class="mb-3">
                                <label>Employee Contribution</label>
                                <input type="number" class="form-control" formControlName="employee_contribution" readonly>
                              </div>
                              <div class="mb-3">
                                <label>Employer Contribution</label>
                                <input type="number" class="form-control" formControlName="employer_contribution" readonly>
                              </div>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button class="btn btn-secondary" (click)="closeAddRssbDeductionModal()" type="button">Cancel</button>
                            <button class="btn btn-primary" (click)="addRssbDeduction()" [disabled]="addRssbDeductionForm.invalid" type="button">Add</button>
                          </div>
                        </ng-template>
                        <hr/>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <h5>Other Deductions</h5>
                          <button class="btn btn-primary" (click)="openAddOtherDeductionModal()" type="button" [disabled]="!isEditingStep[3]">+ Add Deduction</button>
                        </div>
                        <table class="table table-bordered">
                          <thead>
                            <tr>
                              <th>Deduction Name</th>
                              <th>Amount</th>
                              <th>Type</th>
                              <th>Description</th>
                              <th>Action</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let deduction of employeeOtherDeductions; let i = index">
                              <!-- <td>{{ deduction.description }}</td> -->
                              <td>{{ getDeductionName(deduction.deduction_id) }}</td>
                              <td>{{ deduction.amount }}</td>
                              <td>{{ deduction.type }}</td>
                              <td>{{ deduction.description }}</td>
                              <td>
                                <button class="btn btn-warning btn-sm me-1" (click)="openEditOtherDeductionModal(deduction, i)" type="button" [disabled]="!isEditingStep[3]">Modify</button>
                                <button class="btn btn-danger btn-sm" (click)="removeOtherDeduction(i)" type="button" [disabled]="!isEditingStep[3]">Remove</button>
                              </td>
                            </tr>
                            <tr *ngIf="employeeOtherDeductions && employeeOtherDeductions.length === 0">
                              <td colspan="5" class="text-center">No other deductions added.</td>
                            </tr>
                          </tbody>
                        </table>
                        <!-- Add Other Deduction Modal (unchanged) -->
                        <ng-template #addOtherDeductionModal>
                          <div class="modal-header">
                            <h5 class="modal-title">Add Other Deduction</h5>
                            <button type="button" class="btn-close" (click)="closeAddOtherDeductionModal()"></button>
                          </div>
                          <div class="modal-body">
                            <form [formGroup]="addOtherDeductionForm">
                              <div class="mb-3">
                                <label>Description</label>
                                <input type="text" class="form-control" formControlName="description" placeholder="Enter Description (optional)">
                              </div>
                              <div class="mb-3">
                                <label>Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" formControlName="amount" min="0" step="0.01" placeholder="Enter Amount">
                              </div>
                              <div class="mb-3">
                                <label>Type <span class="text-danger">*</span></label>
                                <ng-select [items]="['fixed', 'percentage']"
                                           formControlName="type"
                                           placeholder="Select Type">
                                </ng-select>
                              </div>
                              <div class="mb-3">
                                <label>Deduction <span class="text-danger">*</span></label>
                                <ng-select [items]="otherDeductions"
                                           bindLabel="deduction_name"
                                           bindValue="id"
                                           formControlName="deduction_id"
                                           placeholder="Select Deduction"
                                           (change)="onOtherDeductionSelected()">
                                </ng-select>
                              </div>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button class="btn btn-secondary" (click)="closeAddOtherDeductionModal()" type="button">Cancel</button>
                            <button class="btn btn-primary" (click)="addOtherDeduction()" [disabled]="addOtherDeductionForm.invalid" type="button">Add</button>
                          </div>
                        </ng-template>
                        <!-- Edit Other Deduction Modal (unchanged) -->
                        <ng-template #editOtherDeductionModal>
                          <div class="modal-header">
                            <h5 class="modal-title">Edit Other Deduction</h5>
                            <button type="button" class="btn-close" (click)="closeEditOtherDeductionModal()"></button>
                          </div>
                          <div class="modal-body">
                            <form [formGroup]="editOtherDeductionForm">
                              <div class="mb-3">
                                <label>Description</label>
                                <input type="text" class="form-control" formControlName="description" placeholder="Enter Description (optional)">
                              </div>
                              <div class="mb-3">
                                <label>Amount <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" formControlName="amount" min="0" step="0.01" placeholder="Enter Amount">
                              </div>
                              <div class="mb-3">
                                <label>Type <span class="text-danger">*</span></label>
                                <ng-select [items]="['fixed', 'percentage']"
                                           formControlName="type"
                                           placeholder="Select Type">
                                </ng-select>
                              </div>
                              <div class="mb-3">
                                <label>Deduction <span class="text-danger">*</span></label>
                                <ng-select [items]="otherDeductions"
                                           bindLabel="deduction_name"
                                           bindValue="id"
                                           formControlName="deduction_id"
                                           placeholder="Select Deduction">
                                </ng-select>
                              </div>
                            </form>
                          </div>
                          <div class="modal-footer">
                            <button class="btn btn-secondary" (click)="closeEditOtherDeductionModal()" type="button">Cancel</button>
                            <button class="btn btn-primary" (click)="updateOtherDeduction()" [disabled]="editOtherDeductionForm.invalid || saving" type="button">
                              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                              Update
                            </button>
                          </div>
                        </ng-template>
                        <hr/>
                        <ul class="list-inline wizard d-flex justify-content-end mb-0">
                          <li class="previous list-inline-item" aria-disabled="true">
                            <button class="btn btn-secondary" cdkStepperPrevious>
                              <i class="mdi mdi-arrow-left me-1"></i> Previous
                            </button>
                          </li>
                          <li class="next list-inline-item" aria-disabled="false">
                            <button *ngIf="!isEditingStep[3]" class="btn btn-primary" type="button" (click)="onEditStep(3)">Edit</button>
                            <button *ngIf="isEditingStep[3]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(3)" [disabled]="saving">
                              <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                              Update
                            </button>
                            <button *ngIf="isEditingStep[3]" class="btn btn-outline-danger me-2" type="button" (click)="onCancelEditStep(3)">Cancel</button>
                          </li>
                        </ul>
                      </div>
                    </div>
                  </section>
                </cdk-step>
  
                <!-- Step 5: Bank Information -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">5.</span>
                    <span>Bank Info</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 4">
                    <form [formGroup]="bankInfoForm" novalidate>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Bank Name <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" formControlName="bank_name" placeholder="Enter Bank Name"
                                 [ngClass]="{'is-invalid': submittedBankInfo && bankInfo.bank_name.errors, 'is-valid': submittedBankInfo && bankInfo.bank_name.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBankInfo && bankInfo.bank_name.errors">
                            <span *ngIf="bankInfo.bank_name.errors.required">Bank name is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Account Number <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" formControlName="account_number" placeholder="Enter Account Number"
                                 [ngClass]="{'is-invalid': submittedBankInfo && bankInfo.account_number.errors, 'is-valid': submittedBankInfo && bankInfo.account_number.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBankInfo && bankInfo.account_number.errors">
                            <span *ngIf="bankInfo.account_number.errors.required">Account number is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Account Name <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" formControlName="account_name" placeholder="Enter Account Name"
                                 [ngClass]="{'is-invalid': submittedBankInfo && bankInfo.account_name.errors, 'is-valid': submittedBankInfo && bankInfo.account_name.valid}">
                          <div class="invalid-feedback" *ngIf="submittedBankInfo && bankInfo.account_name.errors">
                            <span *ngIf="bankInfo.account_name.errors.required">Account name is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>IBAN</label>
                          <input type="text" class="form-control" formControlName="iban" placeholder="Enter IBAN (optional)">
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>SWIFT Code</label>
                          <input type="text" class="form-control" formControlName="swift_code" placeholder="Enter SWIFT Code (optional)">
                        </div>
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[4]" class="btn btn-primary" type="button" (click)="onEditStep(4)">Edit</button>
                          <button *ngIf="isEditingStep[4]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(4)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[4]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(4)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>

                <!-- Step 6: Employee Address -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">6.</span>
                    <span>Address</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 5">
                    <form [formGroup]="employeeAddressForm" novalidate>
                      <!--
                      <div class="col-lg-4 mb-3">
                        <label>Type <span class="text-danger">*</span></label>
                        <ng-select [items]="['current', 'permanent']"
                                   formControlName="type"
                                   placeholder="Select Address Type"
                                   [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.type.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.type.valid}">
                        </ng-select>
                        <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.type.errors">
                          <span *ngIf="employeeAddress.type.errors.required">Type is required.</span>
                        </div>
                      </div>
                      -->
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Country <span class="text-danger">*</span></label>
                          <ng-select [items]="countries"
                                     bindLabel="country"
                                     bindValue="id"
                                     formControlName="country"
                                     placeholder="Select Country"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.country.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.country.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.country.errors">
                            <span *ngIf="employeeAddress.country.errors.required">Country is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Province <span class="text-danger">*</span></label>
                          <ng-select [items]="provinces"
                                     bindLabel="libelle_localisation"
                                     bindValue="id"
                                     formControlName="province"
                                     (change)="onProvinceChange($event?.id)"
                                     placeholder="Select Province"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.province.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.province.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.province.errors">
                            <span *ngIf="employeeAddress.province.errors.required">Province is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>District <span class="text-danger">*</span></label>
                          <ng-select [items]="districts"
                                     bindLabel="libelle_localisation"
                                     bindValue="id"
                                     formControlName="district"
                                     (change)="onDistrictChange($event?.id)"
                                     placeholder="Select District"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.district.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.district.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.district.errors">
                            <span *ngIf="employeeAddress.district.errors.required">District is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Sector <span class="text-danger">*</span></label>
                          <ng-select [items]="sectors"
                                     bindLabel="libelle_localisation"
                                     bindValue="id"
                                     formControlName="sector"
                                     (change)="onSectorChange($event?.id)"
                                     placeholder="Select Sector"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.sector.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.sector.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.sector.errors">
                            <span *ngIf="employeeAddress.sector.errors.required">Sector is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Cell <span class="text-danger">*</span></label>
                          <ng-select [items]="cells"
                                     bindLabel="libelle_localisation"
                                     bindValue="id"
                                     formControlName="cell"
                                     (change)="onCellChange($event?.id)"
                                     placeholder="Select Cell"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.cell.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.cell.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.cell.errors">
                            <span *ngIf="employeeAddress.cell.errors.required">Cell is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Village <span class="text-danger">*</span></label>
                          <ng-select [items]="villages"
                                     bindLabel="libelle_localisation"
                                     bindValue="id"
                                     formControlName="village"
                                     placeholder="Select Village"
                                     [ngClass]="{'is-invalid': submittedEmployeeAddress && employeeAddress.village.errors, 'is-valid': submittedEmployeeAddress && employeeAddress.village.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedEmployeeAddress && employeeAddress.village.errors">
                            <span *ngIf="employeeAddress.village.errors.required">Village is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                       
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>City</label>
                          <input type="text" class="form-control" formControlName="city" placeholder="Enter City (optional)">
                        </div>
                        -->
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Additional Address</label>
                          <input type="text" class="form-control" formControlName="additional_address" placeholder="Enter Additional Address (optional)">
                        </div>
                        -->
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Postal Code</label>
                          <input type="text" class="form-control" formControlName="postal_code" placeholder="Enter Postal Code (optional)">
                        </div>
                        -->
                        <!--
                        <div class="col-lg-4 mb-3">
                          <label>Street Address</label>
                          <input type="text" class="form-control" formControlName="street_address" placeholder="Enter Street Address (optional)">
                        </div>
                        -->
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[5]" class="btn btn-primary" type="button" (click)="onEditStep(5)">Edit</button>
                          <button *ngIf="isEditingStep[5]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(5)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[5]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(5)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>

                <!-- Step 7: Emergency -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">7.</span>
                    <span>Emergency</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 6">
                    <form [formGroup]="emergencyContactForm" novalidate>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Name</label>
                          <input type="text" class="form-control" formControlName="name" placeholder="Enter Name"
                                 [ngClass]="{'is-invalid': submittedEmergencyContact && emergencyContact.name.errors, 'is-valid': submittedEmergencyContact && emergencyContact.name.valid}">
                          <div class="invalid-feedback" *ngIf="submittedEmergencyContact && emergencyContact.name.errors"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Gender</label>
                          <ng-select [items]="['male', 'female', 'other']"
                                     formControlName="gender"
                                     placeholder="Select Gender">
                          </ng-select>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Relationship</label>
                          <input type="text" class="form-control" formControlName="relationship" placeholder="Enter Relationship"
                                 [ngClass]="{'is-invalid': submittedEmergencyContact && emergencyContact.relationship.errors, 'is-valid': submittedEmergencyContact && emergencyContact.relationship.valid}">
                          <div class="invalid-feedback" *ngIf="submittedEmergencyContact && emergencyContact.relationship.errors"></div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Phone</label>
                          <input type="text" class="form-control" formControlName="phone" placeholder="Enter Phone"
                                 [ngClass]="{'is-invalid': submittedEmergencyContact && emergencyContact.phone.errors, 'is-valid': submittedEmergencyContact && emergencyContact.phone.valid}">
                          <div class="invalid-feedback" *ngIf="submittedEmergencyContact && emergencyContact.phone.errors"></div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Email</label>
                          <input type="email" class="form-control" formControlName="email" placeholder="Enter Email (optional)">
                        </div>
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[6]" class="btn btn-primary" type="button" (click)="onEditStep(6)">Edit</button>
                          <button *ngIf="isEditingStep[6]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(6)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[6]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(6)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>
  
                <!-- Step 8: Documents -->
                <cdk-step [optional]="true">
                  <ng-template cdkStepLabel>
                    <span class="number">8.</span>
                    <span>Documents</span>
                  </ng-template>
                  <section *ngIf="cdkStepper.selectedIndex === 7">
                    <form [formGroup]="documentsForm" novalidate>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Document Type <span class="text-danger">*</span></label>
                          <ng-select [items]="documentTypes"
                                     bindLabel="label"
                                     bindValue="value"
                                     formControlName="document_type_id"
                                     placeholder="Select Document Type"
                                     [ngClass]="{'is-invalid': submittedDocuments && documents.document_type_id.errors, 'is-valid': submittedDocuments && documents.document_type_id.valid}">
                          </ng-select>
                          <div class="invalid-feedback d-block" *ngIf="submittedDocuments && documents.document_type_id.errors">
                            <span *ngIf="documents.document_type_id.errors.required">Document type is required.</span>
                          </div>
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Document File <span class="text-danger">*</span></label>
                          <input type="file" class="form-control" (change)="onDocumentFileChange($event)" [ngClass]="{'is-invalid': submittedDocuments && documents.document.errors, 'is-valid': submittedDocuments && documents.document.valid}">
                          <div class="invalid-feedback" *ngIf="submittedDocuments && documents.document.errors">
                            <span *ngIf="documents.document.errors.required">Document file is required.</span>
                          </div>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-lg-4 mb-3">
                          <label>Description</label>
                          <input type="text" class="form-control" formControlName="description" placeholder="Enter Description (optional)">
                        </div>
                        <div class="col-lg-4 mb-3">
                          <label>Expiration Date</label>
                          <input type="date" class="form-control" formControlName="expiration_date">
                        </div>
                      </div>
                      <ul class="list-inline wizard d-flex justify-content-end mb-0">
                        <li class="previous list-inline-item" aria-disabled="true">
                          <button class="btn btn-secondary" cdkStepperPrevious>
                            <i class="mdi mdi-arrow-left me-1"></i> Previous
                          </button>
                        </li>
                        <li class="next list-inline-item" aria-disabled="false">
                          <button *ngIf="!isEditingStep[7]" class="btn btn-primary" type="button" (click)="onEditStep(7)">Edit</button>
                          <button *ngIf="isEditingStep[7]" class="btn btn-success me-2" type="button" (click)="onUpdateStep(7)" [disabled]="saving">
                            <span *ngIf="saving" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            Update
                          </button>
                          <button *ngIf="isEditingStep[7]" class="btn btn-outline-danger" type="button" (click)="onCancelEditStep(7)">Cancel</button>
                        </li>
                      </ul>
                    </form>
                  </section>
                </cdk-step>
  
              </ng-stepper>
            </div>
  
          </div>
          <!-- end card body -->
        </div>
        <!-- end card -->
      </div>
      <!-- end col -->
    </div>
    <!-- end row -->
    <!-- Start Form Wizard vertical row-->
    <!-- end row -->
  </div>